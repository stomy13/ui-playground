# 設計文書

## 概要

Vite + React 19 + TanStack Router を用いたシングルページアプリケーションに「画像圧縮」ページを追加します。ホーム画面のカードコンポーネントから `/compression` ルートへ遷移し、クライアントサイドで画像のリサイズと複数ライブラリによる圧縮を実行、結果比較を提供します。UI は MUI コンポーネントを基盤としつつ、カスタムフックと Zustand でフォーム状態・処理結果を管理します。

## アーキテクチャ

### 技術スタック
- **ビルド/実行**: Vite 6, React 19, TypeScript 5.8
- **ルーティング**: TanStack Router 1.x（`src/routes`）
- **UI コンポーネント**: MUI v7 + emotion（既存テーマを継承）
- **状態管理**: Zustand（圧縮ジョブ状態）, React Hook Form（入力フォーム）
- **非同期処理**: Web Worker（Vite `*.worker.ts`） + `browser-image-compression` / `@squoosh/lib`
- **ユーティリティ**: `CompressorRegistry`（圧縮ライブラリ DI 用の設定モジュール）

### ディレクトリ方針

```
src/
├── pages/ImageCompression/          # ページコンテナ
│   ├── ImageCompression.tsx         # ルートコンポーネント
│   └── components/                  # ページ固有 UI
├── routes/image-compression.lazy.tsx
├── workers/compression.worker.ts    # 圧縮処理ワーカー
├── utils/compression/
│   ├── registry.ts                  # ライブラリ一覧定義
│   ├── types.ts                     # 圧縮結果型
│   └── transformers.ts              # リサイズ/前処理
└── store/compressionStore.ts        # Zustand ストア
```

## 画面設計

### ワイヤーフレーム（テキスト）

```
┌────────────────────────────────────────────┐
│ ヘッダー / パンくず                        │
├────────────────────────────────────────────┤
│ タイトル: 画像圧縮                          │
│ サブタイトル: プレビューと比較              │
├────────────────┬───────────────────────────┤
│ 左カラム                                       │
│ ┌──────────────┐   ┌──────────────────┐   │
│ │ 画像選択パネル │   │ 入力ヘルプ/制約 │   │
│ │ [ファイル選択] │   │ ・対応形式       │   │
│ │ プレビュー枠   │   │ ・最大サイズ等   │   │
│ │ 元ファイル情報 │   └──────────────────┘   │
│ └──────────────┘                        │
│ ┌──────────────┐                        │
│ │ リサイズ/圧縮  │ 幅 [   ] px            │
│ │ フォーム       │ 高さ [   ] px          │
│ │ [✓] 縦横比維持 │ 圧縮率 [   ] %          │
│ │ 出力形式選択   │ [圧縮を実行]ボタン      │
│ └──────────────┘                        │
├────────────────┴───────────────────────────┤
│ 右カラム（結果比較）                         │
│ ┌──────────────────────────────────────┐ │
│ │ タブ / アコーディオン：ライブラリ別       │ │
│ │ ・Browser Image Compression            │ │
│ │ ・Squoosh MozJPEG                      │ │
│ │ ・Squoosh WebP                         │ │
│ ├──────────────────────────────────────┤ │
│ │ 各カード:                                 │ │
│ │  プレビュー (Before/After スライダー)    │ │
│ │  サイズ情報: 元/結果/削減率             │ │
│ │  [ダウンロード] ボタン                  │ │
│ │  エラーメッセージ領域                   │ │
│ └──────────────────────────────────────┘ │
└────────────────────────────────────────────┘
```

### ユーザーフロー

1. ホームのカードクリックで `/compression` へ遷移
2. ファイル選択 → 即座にプレビュー・元サイズ表示
3. フォームで幅/高さ/圧縮率/フォーマットを調整
4. `圧縮を実行` クリックで全ライブラリ向けジョブを発行
5. 進行表示 → 完了後タブに結果が並び、差分情報とダウンロード操作を提供
6. 再入力または別画像選択時はストアをリセットし再処理

## 状態管理とデータフロー

- `compressionStore`: 画像ファイル、フォーム入力、各ライブラリの進行状況/結果/エラーを保持
- `CompressionWorker`: リサイズ済み ImageBitmap と各ライブラリ設定を受け取り、Base64 ではなく ArrayBuffer を返却
- `CompressionRegistry`: `id`, `label`, `compress(payload)`, `supportsFormat` などを定義
- React Hook Form でフォームバリデーションを実施し、未定義/不正値の場合は `圧縮を実行` を無効化

## エラーハンドリング

- ファイル形式/サイズ制限違反でトースト + フィールドエラーメッセージ
- 各ライブラリ失敗時はそのカードのみ `error` 状態でリトライボタンを表示
- Web Worker 生成失敗時はフォールバックでメインスレッド圧縮を試みつつ警告表示

## アクセシビリティ & レスポンシブ

- キーボード操作: フォーム要素、タブ切り替え、ダウンロードボタンにフォーカス順序を定義
- スクリーンリーダー: プレビュー画像へ `alt`、差分表に `aria` 属性を付与
- レイアウト: `md` 以上は 2 カラム、`sm` 以下は縦並びに切り替え、結果カードは横スクロール

## テスト観点

- フォームバリデーション（必須、範囲、アスペクト比ロック）の単体テスト
- Worker モジュールの圧縮結果（モック化）比較テスト
- E2E: 画像選択→圧縮→ダウンロード操作のフロー確認、異常系エラー表示
