# 要件文書

## 概要

ホーム画面のカードコンポーネントから遷移できる画像圧縮アプリです。ユーザーが画像ファイルを選択し、リサイズ後の想定サイズと圧縮率を指定すると、複数の圧縮ライブラリで処理した結果を比較しながら確認できます。圧縮前後の画像プレビューとファイルサイズ（バイト数）を表示し、出力の品質と圧縮効果を把握できるようにします。

## 要件

### 要件 1

**ユーザーストーリー:** ホーム画面の訪問者として、画像圧縮ツールのカードをクリックしたら専用ページに遷移したいので、迷わず作業を始められる

#### 受入基準

1. WHEN ホーム画面で画像圧縮カードをクリックする THEN システムは画像圧縮ページに遷移する SHALL
2. WHEN 画像圧縮ページが表示される THEN システムはページタイトルとパンくず/戻る導線を表示する SHALL
3. WHEN ページのURLに直接アクセスする THEN システムは画像圧縮ページを単独で表示する SHALL

### 要件 2

**ユーザーストーリー:** ユーザーとして、画像ファイルを選択してすぐに確認したいので、プレビューと元サイズを見られる

#### 受入基準

1. WHEN ファイル選択ボタンからサポート対象の画像ファイルを選択する THEN システムは画像プレビューと元ファイルのバイトサイズを表示する SHALL
2. WHEN 非対応形式や2枚以上のファイルを選択する THEN システムはエラーメッセージを表示しプレビューを更新しない SHALL
3. WHEN 新しい画像ファイルを選択する THEN システムはプレビューと関連入力値を更新し以前の圧縮結果をクリアする SHALL

### 要件 3

**ユーザーストーリー:** ユーザーとして、出力の大きさと品質を制御したいので、リサイズ後の寸法と圧縮率を入力できる

#### 受入基準

1. WHEN 画像圧縮ページが表示される THEN システムはリサイズ後の幅・高さと圧縮率の初期値をフォームに表示する SHALL
2. WHEN 幅・高さ・圧縮率の値が未入力または範囲外である THEN システムはエラー表示を行い圧縮ボタンを無効化する SHALL
3. WHEN ユーザーがフォームの値を編集する THEN システムは次の圧縮リクエストに編集後の値を使用する SHALL

### 要件 4

**ユーザーストーリー:** ユーザーとして、入力した条件で画像を圧縮したいので、圧縮ボタンを押して結果を確認できる

#### 受入基準

1. WHEN 圧縮ボタンをクリックする AND 入力と画像が有効である THEN システムは全ての設定済み圧縮ライブラリで処理を開始する SHALL
2. WHEN 圧縮処理が進行中である THEN システムは進行状況または処理中であることを示すフィードバックを表示する SHALL
3. WHEN 圧縮処理が完了する THEN システムは各ライブラリごとに圧縮後の画像プレビューを表示する SHALL

### 要件 5

**ユーザーストーリー:** ユーザーとして、圧縮結果の効果を理解したいので、圧縮前後のサイズと差分を比較したい

#### 受入基準

1. WHEN 各ライブラリの圧縮結果が表示される THEN システムは元画像と圧縮後画像のバイトサイズ、差分の割合を表示する SHALL
2. WHEN 複数ライブラリの結果が表示される THEN システムは見出しやタブなどでライブラリ名を識別できるようにする SHALL
3. WHEN 圧縮処理の結果が取得できないライブラリがある THEN システムはそのライブラリのセクションにエラー状態を表示する SHALL

### 要件 6

**ユーザーストーリー:** プロジェクトメンテナとして、比較対象の圧縮ライブラリを柔軟に入れ替えたいので、実装が特定ライブラリに固定されないようにしたい

#### 受入基準

1. WHEN 圧縮ライブラリの一覧を構成する THEN システムは設定ファイルまたはコード上の定義を通じて2つ以上のライブラリを登録できる SHALL
2. WHEN 新しいライブラリ定義が追加される THEN システムはライブラリ名、圧縮関数、サポート形式の指定を必須項目として受け付ける SHALL
3. WHEN ライブラリ定義が存在しない場合 THEN システムは圧縮フォームを表示しつつ「ライブラリが設定されていない」旨の警告を表示する SHALL

## オープン項目と決定事項

1. **圧縮ライブラリ候補** (優先度: 高)
   - 決定: 初期リリースでは `browser-image-compression`（ブラウザ内JPEG/PNG圧縮）と `@squoosh/lib` の MozJPEG / WebP コーデックを採用し、比較表示する
   - 対応方針: ライブラリは `CompressionPipeline` 設定オブジェクトで差し替え可能にし、将来的な追加も設定変更のみで完結させる

2. **圧縮処理の実行環境** (優先度: 中)
   - 決定: 初期段階からViteの Web Worker (`*.worker.ts`) を用いて圧縮処理を実行し、UI スレッドのブロッキングを回避する。バックエンド処理は要件外とする
   - 対応方針: ライブラリごとにワーカー内で処理し、メインスレッドとは Comlink なしで postMessage ベースの具象型メッセージを交換する

3. **画像リサイズルール** (優先度: 高)
   - 決定: 幅・高さはいずれか片方を入力するとアスペクト比を維持してもう片方を自動算出する。比率ロックを解除する「縦横比を無視」トグルを提供する
   - 対応方針: 元画像のメタデータから縦横比を算出しフォームのリアルタイム検証に利用する

4. **圧縮結果の配布方法** (優先度: 中)
   - 決定: 各ライブラリ結果カードに `ダウンロード` ボタンを配置し、Blob URL での手動ダウンロードを提供する。自動ダウンロードは行わない
   - 対応方針: 複数結果の一括保存は後続検討とし、Issue 化して保留する
